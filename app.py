from flask import Flask, render_template, request, jsonify
from datetime import datetime
import os

app = Flask(__name__)

# נתונים קבועים
initial_agents = [
    {"שם פרטי": "חלי", "שם משפחה": "דיין", "מספר מפנה": "2195"},
    {"שם פרטי": "אביקו", "שם משפחה": "פולד", "מספר מפנה": "2421"},
    {"שם פרטי": "אלינה", "שם משפחה": "דיין", "מספר מפנה": "2192"},
    {"שם פרטי": "שמעון", "שם משפחה": "ברון", "מספר מפנה": "2060"},
    {"שם פרטי": "עמית", "שם משפחה": "ניסל", "מספר מפנה": "2861"},
    {"שם פרטי": "שרון", "שם משפחה": "סיני", "מספר מפנה": "2420"},
    {"שם פרטי": "יוסי", "שם משפחה": "לוי", "מספר מפנה": "2623"},
    {"שם פרטי": "אורן", "שם משפחה": "שוקרון", "מספר מפנה": "2214"},
    {"שם פרטי": "גיא", "שם משפחה": "מרציאנו", "מספר מפנה": "2809"},
    {"שם פרטי": "יעקב", "שם משפחה": "חביבה", "מספר מפנה": "2487"},
    {"שם פרטי": "מאיר", "שם משפחה": "סולטנו", "מספר מפנה": "2202"},
    {"שם פרטי": "דודו", "שם משפחה": "מרציאנו", "מספר מפנה": "2778"},
    {"שם פרטי": "שרית", "שם משפחה": "אשר", "מספר מפנה": "2775"},
    {"שם פרטי": "עדי", "שם משפחה": "כהן", "מספר מפנה": "1957"},
    {"שם פרטי": "אמיר", "שם משפחה": "גלילה", "מספר מפנה": "2196"},
    {"שם פרטי": "דניאל", "שם משפחה": "שימונוב", "מספר מפנה": "1721"},
    {"שם פרטי": "צור", "שם משפחה": "דהב", "מספר מפנה": "2197"},
    {"שם פרטי": "צור", "שם משפחה": "משען", "מספר מפנה": "1923"},
    {"שם פרטי": "ליאור", "שם משפחה": "טוב יום", "מספר מפנה": "1210"},
    {"שם פרטי": "אלי", "שם משפחה": "דבורה", "מספר מפנה": "1693"},
    {"שם פרטי": "זיו", "שם משפחה": "סויסה", "מספר מפנה": "2771"},
    {"שם פרטי": "אורלי", "שם משפחה": "אברהם", "מספר מפנה": "1709"},
    {"שם פרטי": "עופר", "שם משפחה": "סככי", "מספר מפנה": "1703"},
    {"שם פרטי": "אליהו", "שם משפחה": "זמיר", "מספר מפנה": "2777"},
    {"שם פרטי": "תמיר", "שם משפחה": "דיין", "מספר מפנה": "2128"},
    {"שם פרטי": "אליאור", "שם משפחה": "דביר", "מספר מפנה": "2445"},
    {"שם פרטי": "עמית", "שם משפחה": "שחר", "מספר מפנה": "1793"},
    {"שם פרטי": "אמיר", "שם משפחה": "ישראל", "מספר מפנה": "2806"},
    {"שם פרטי": "שחר", "שם משפחה": "רווח", "מספר מפנה": "2359"},
    {"שם פרטי": "אדריאן", "שם משפחה": "קוצ'ולוב", "מספר מפנה": "2358"},
    {"שם פרטי": "עדן", "שם משפחה": "כהן", "מספר מפנה": "2747"},
    {"שם פרטי": "חלי", "שם משפחה": "רון", "מספר מפנה": "2615"},
    {"שם פרטי": "אסף", "שם משפחה": "שאולי", "מספר מפנה": "2746"},
    {"שם פרטי": "יותם", "שם משפחה": "נגר", "מספר מפנה": "1898"},
    {"שם פרטי": "לירון", "שם משפחה": "אלגרבלי", "מספר מפנה": "1183"},
    {"שם פרטי": "קובי", "שם משפחה": "רדמון", "מספר מפנה": "264"},
    {"שם פרטי": "אבי", "שם משפחה": "שי", "מספר מפנה": "2444"},
    {"שם פרטי": "פיני", "שם משפחה": "קנדי", "מספר מפנה": "1712"},
    {"שם פרטי": "ארז", "שם משפחה": "קראוני", "מספר מפנה": "1745"},
    {"שם פרטי": "ארז", "שם משפחה": "שלמוני", "מספר מפנה": "2283"},
    {"שם פרטי": "בנצי", "שם משפחה": "שיש", "מספר מפנה": "2422"},
    {"שם פרטי": "אריאל", "שם משפחה": "אוחיון", "מספר מפנה": "2720"},
    {"שם פרטי": "ניב", "שם משפחה": "מלמקר", "מספר מפנה": "2727"},
    {"שם פרטי": "עדי", "שם משפחה": "ניסים", "מספר מפנה": "2397"},
    {"שם פרטי": "דנית", "שם משפחה": "בלוקה", "מספר מפנה": "2673"},
    {"שם פרטי": "אילן", "שם משפחה": "עזרא", "מספר מפנה": "2672"},
    {"שם פרטי": "עדי", "שם משפחה": "בן צבי", "מספר מפנה": "2671"},
    {"שם פרטי": "בועז", "שם משפחה": "חן", "מספר מפנה": "2670"},
    {"שם פרטי": "אריאל", "שם משפחה": "כפיר", "מספר מפנה": "2669"},
    {"שם פרטי": "שמעון", "שם משפחה": "הורנצ'יק", "מספר מפנה": "2668"},
    {"שם פרטי": "נתי", "שם משפחה": "בן חמו", "מספר מפנה": "2808"},
    {"שם פרטי": "חלי", "שם משפחה": "רון", "מספר מפנה": "2615"},
    {"שם פרטי": "בנצי", "שם משפחה": "שיש", "מספר מפנה": "2422"},
    {"שם פרטי": "מרים", "שם משפחה": "בן צבי", "מספר מפנה": "1032"},
    {"שם פרטי": "נתי", "שם משפחה": "פרנסיס", "מספר מפנה": "578"},
    {"שם פרטי": "אבי", "שם משפחה": "ברכיהו", "מספר מפנה": "2723"},
    {"שם פרטי": "יגל", "שם משפחה": "שפיגלר", "מספר מפנה": "2802"},
    {"שם פרטי": "נפתלי", "שם משפחה": "סיידה", "מספר מפנה": "2805"},
    {"שם פרטי": "עמוס", "שם משפחה": "חלפון", "מספר מפנה": "2807"},
    {"שם פרטי": "בן", "שם משפחה": "בן בסט", "מספר מפנה": "2860"},
    {"שם פרטי": "עומר", "שם משפחה": "קיט", "מספר מפנה": "2859"},
    {"שם פרטי": "בוריס", "שם משפחה": "בורוכוב", "מספר מפנה": "2853"},
    {"שם פרטי": "בנצי", "שם משפחה": "לויץ", "מספר מפנה": "2852"},
    {"שם פרטי": "דהוד", "שם משפחה": "כהן זהדה", "מספר מפנה": "2819"},
    {"שם פרטי": "עדן", "שם משפחה": "כהן", "מספר מפנה": "2747"},
    {"שם פרטי": "אבי", "שם משפחה": "ברכיהו", "מספר מפנה": "2723"}
]


# קישורים מוכנים לשליחה - קבועים בקוד
SAVED_LINKS = {
    "2195": [  # קישורים של חלי דיין
        {
            "title": "מטרות ויעדים למשק הבית",
            "text": """מטרות ויעדים למשק הבית
29.10.2024

https://goola-group.com/webinars/niv-20-10-24/?refferer_id=xxx&target=yyy""",
            "post_text": """תדמיינו שנכנסתם לרכב, לחצתם על הוויז וביקשתם ממנו מסלול בלי להזין כתובת.
בלי יעד הוויז לא יודע לתת לנו מסלול.
כך בדיוק גם בחיים, כשאתם לא מגדירים לכם יעדים ברורים, קשה להגדיר את המסלול כדי לעמוד ביעד.
במפגש הקרוב תגלו איך הגדרת מטרות ויעדים ישפרו באופן ניכר את העתיד הכלכלי שלכם.""",
            "date": "2024-01-01"
        },
        {
            "title": "האתגר הפנסיוני בעולם המערבי",
            "text": """האתגר הפנסיוני בעולם המערבי
29.10.2024

https://goola-group.com/webinars/kobi-20-11-24/?refferer_id=xxx&target=yyy""",
            "post_text": """מי מאיתנו לא מדמיין את תקופת הפנסיה, טיולים סביב העולם, עזרה לילדים, בילוי עם הנכדים בקיצור הרבה זמן פנוי שמחייב הכנסה משמעותית.
אז איך תבטיחו לעצמכם הכנסה גבוהה? 
אילו אתגרים עומדים בדרככם?
והכי חשוב איך תוכלו לשפר באופן פשוט וקל את החיסכון שלכם באופן משמעותי""",
            "date": "2024-01-02"
        },
        {
            "title": "הטבות מס",
            "text": """הטבות מס
29.10.2024

https://goola-group.com/webinars/kobi-04-12-24/?refferer_id=xxx&target=yyy""",
            "post_text": """מרבית אזרחי ישראל לא מודעים להטבות מס שמגיעות להם.
הטבות ששוות לכם המון כסף.
אז לא משנה אם אתם עצמאיים או שכירים או אפילו פנסיונרים, יש הטבות מס שתופתעו כמה הם שווים לכם והופכים את החיסכון במסלולים אלו לכדאיים במיוחד.""",
            "date": "2024-01-03"
        },
        {
            "title": "תכנית עבודה שנתית 2025",
            "text": """תכנית עבודה שנתית 2025
29.10.2024

https://goola-group.com/webinars/sarit-18-12-24/?refferer_id=xxx&target=yyy""",
            "post_text": """איך תהפכו את שנת 2025 להכי מוצלחת שאפשר?
תוכנית עבודה זה סוד ההצלחה. 
יש תוכנית – יש כיוון
יש תוכנית – יודעים מה לעשות.
אבל איך מכינים תוכנית עבודה? 
אנחנו כאן בשבילכם כדי להסביר לכם את העקרונות לכתיבת תוכנית עבודה אפקטיבית.""",
            "date": "2024-01-04"
        }
    ],
    "2421": [  # קישורים של ויקטור אביחי פלד
        {
            "title": "וובינר השקעות",
            "text": """💰 הזמנה לוובינר: השקעות חכמות
מה נלמד בוובינר?
✅ בניית תיק השקעות מאוזן
✅ ניהול סיכונים נכון""",
            "post_text": "",
            "date": "2024-01-03"
        }
    ]
}

@app.route('/')
def index():
    return render_template('index.html', 
                         agents=initial_agents,
                         saved_links=SAVED_LINKS)  # העברת הקישורים לתבנית

@app.route('/api/saved-links/<agent_id>', methods=['GET'])
def get_saved_links(agent_id):
    # החזרת הקישורים השמורים לסוכן
    return jsonify(SAVED_LINKS.get(agent_id, []))

@app.route('/api/saved-links/<agent_id>', methods=['POST'])
def add_saved_link(agent_id):
    data = request.json
    if agent_id not in SAVED_LINKS:
        SAVED_LINKS[agent_id] = []
    
    SAVED_LINKS[agent_id].append({
        "title": data.get('title'),
        "text": data.get('text'),
        "post_text": data.get('post_text', ''),
        "date": datetime.now().strftime('%Y-%m-%d')
    })
    
    return jsonify({"message": "Link saved successfully"})

@app.route('/generate_link', methods=['POST'])
def generate_link():
    base_link = request.form.get('link', '')
    agent_id = request.form.get('agent', '')
    free_text = request.form.get('free_text', '')
    
    custom_link = f"{base_link}?ref={agent_id}"
    full_text = f"{free_text}\n\n{custom_link}" if free_text else custom_link
    
    return jsonify({
        'custom_link': custom_link,
        'full_text': full_text,
        'title': 'כותרת לדוגמה',
        'description': 'תיאור לדוגמה',
        'image_url': 'https://example.com/image.jpg'
    })

@app.route('/api/agents', methods=['POST'])
def add_agent():
    try:
        data = request.json
        new_agent = {
            "שם פרטי": data['first_name'],
            "שם משפחה": data['last_name'],
            "מספר מפנה": data['referral_id']
        }
        initial_agents.append(new_agent)
        return jsonify({"message": "Agent added successfully", "agent": new_agent})
    except Exception as e:
        return jsonify({"error": str(e)}), 400

@app.route('/api/agents/<agent_id>', methods=['DELETE'])
def delete_agent(agent_id):
    try:
        global initial_agents
        initial_agents = [agent for agent in initial_agents if agent['מספר מפנה'] != agent_id]
        return jsonify({"message": "Agent deleted successfully"})
    except Exception as e:
        return jsonify({"error": str(e)}), 400

if __name__ == '__main__':
    port = int(os.environ.get('PORT', 8080))
    app.run(host='0.0.0.0', port=port)